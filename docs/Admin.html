<!DOCTYPE html>  <html> <head>   <title>Admin.coffee</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>            <div id="jump_to">         Jump To &hellip;         <div id="jump_wrapper">           <div id="jump_page">                                           <a class="source" href="Admin.html">                 Admin.coffee               </a>                                           <a class="source" href="BrowserEntry.html">                 BrowserEntry.coffee               </a>                        </div>         </div>       </div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               Admin.coffee             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>                            </td>             <td class="code">               <div class="highlight"><pre><span class="k">class</span> <span class="nx">Admin</span>
  <span class="nv">constructor: </span><span class="nf">(@options) -&gt;</span>
    <span class="nx">do</span> <span class="nx">@handleOptions</span>
    <span class="vi">@http = </span><span class="nx">require</span> <span class="s">&#39;http&#39;</span>
    <span class="k">return</span> <span class="nx">@</span>

  <span class="nv">handleOptions: </span><span class="o">=&gt;</span>
    <span class="k">if</span> <span class="nx">@options</span><span class="p">.</span><span class="nx">url</span><span class="o">?</span>
      <span class="nx">@options</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">?=</span> <span class="nx">value</span> <span class="k">for</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">value</span> <span class="k">of</span> <span class="nx">require</span><span class="p">(</span><span class="s">&#39;url&#39;</span><span class="p">).</span><span class="nx">parse</span> <span class="nx">@options</span><span class="p">.</span><span class="nx">url</span>
    <span class="p">[</span><span class="nx">@options</span><span class="p">.</span><span class="nx">username</span><span class="p">,</span> <span class="nx">@options</span><span class="p">.</span><span class="nx">password</span><span class="p">]</span> <span class="o">=</span> <span class="nx">@options</span><span class="p">.</span><span class="nx">auth</span><span class="p">.</span><span class="nx">split</span> <span class="s">&#39;:&#39;</span> <span class="k">if</span> <span class="nx">@options</span><span class="p">.</span><span class="nx">auth</span><span class="o">?</span>
    <span class="nx">@options</span><span class="p">.</span><span class="nx">protocol</span> <span class="o">?=</span>   <span class="s">&#39;https:&#39;</span> <span class="k">if</span> <span class="nx">@options</span><span class="p">.</span><span class="nx">ssl</span><span class="o">?</span>
    <span class="nx">@options</span><span class="p">.</span><span class="nx">host</span> <span class="o">?=</span>       <span class="nx">@options</span><span class="p">.</span><span class="nx">hostname</span>
    <span class="nv">host = </span>                <span class="nx">@options</span><span class="p">.</span><span class="nx">host</span><span class="p">.</span><span class="nx">split</span> <span class="s">&#39;:&#39;</span>
    <span class="nx">@options</span><span class="p">.</span><span class="nx">hostname</span> <span class="o">?=</span>   <span class="nx">host</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="nx">@options</span><span class="p">.</span><span class="nx">port</span> <span class="o">?=</span>       <span class="nx">host</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="nx">@options</span><span class="p">.</span><span class="nx">username</span> <span class="o">?=</span>   <span class="s">&#39;admin&#39;</span>
    <span class="nx">@options</span><span class="p">.</span><span class="nx">protocol</span> <span class="o">?=</span>   <span class="s">&#39;http:&#39;</span>
    <span class="nx">@options</span><span class="p">.</span><span class="nx">port</span> <span class="o">?=</span>       <span class="k">if</span> <span class="nx">@options</span><span class="p">.</span><span class="nx">protocol</span> <span class="o">is</span> <span class="s">&#39;https:&#39;</span> <span class="k">then</span> <span class="mi">443</span> <span class="k">else</span> <span class="mi">80</span>
    <span class="vi">@options.port = </span>       <span class="nb">parseInt</span> <span class="nx">@options</span><span class="p">.</span><span class="nx">port</span>
    <span class="nx">@options</span><span class="p">.</span><span class="nx">path</span> <span class="o">?=</span>       <span class="s">&#39;/&#39;</span>
    <span class="nx">@options</span><span class="p">.</span><span class="nx">pathname</span> <span class="o">?=</span>   <span class="nx">@options</span><span class="p">.</span><span class="nx">path</span>
    <span class="vi">@options.host = </span>       <span class="s">&quot;</span><span class="si">#{</span><span class="nx">@options</span><span class="p">.</span><span class="nx">hostname</span><span class="si">}</span><span class="s">:</span><span class="si">#{</span><span class="nx">@options</span><span class="p">.</span><span class="nx">port</span><span class="si">}</span><span class="s">&quot;</span>
    <span class="nx">@options</span><span class="p">.</span><span class="nx">verbose</span> <span class="o">?=</span>    <span class="kc">false</span>
    <span class="k">delete</span> <span class="nx">@options</span><span class="p">.</span><span class="nx">href</span>
    <span class="k">delete</span> <span class="nx">@options</span><span class="p">.</span><span class="nx">url</span>
    <span class="k">delete</span> <span class="nx">@options</span><span class="p">.</span><span class="nx">slashes</span>
    <span class="k">delete</span> <span class="nx">@options</span><span class="p">.</span><span class="nx">auth</span>

  <span class="nv">fetchXml: </span><span class="p">(</span><span class="nx">path</span><span class="p">,</span> <span class="nv">fn = </span><span class="kc">null</span><span class="p">)</span> <span class="o">=&gt;</span>
    <span class="nv">fullpath = </span><span class="s">&quot;</span><span class="si">#{</span><span class="nx">@options</span><span class="p">.</span><span class="nx">path</span><span class="si">}#{</span><span class="nx">path</span><span class="si">}</span><span class="s">&quot;</span>
    <span class="k">if</span> <span class="nx">@options</span><span class="p">.</span><span class="nx">verbose</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">info</span> <span class="s">&quot;Fetching </span><span class="si">#{</span><span class="nx">fullpath</span><span class="si">}</span><span class="s">&quot;</span>
    <span class="nv">client = </span><span class="nx">@http</span><span class="p">.</span><span class="nx">request</span>
      <span class="nv">host: </span>  <span class="nx">@options</span><span class="p">.</span><span class="nx">hostname</span>
      <span class="nv">port: </span>  <span class="nx">@options</span><span class="p">.</span><span class="nx">port</span>
      <span class="nv">method: </span><span class="s">&#39;GET&#39;</span>
      <span class="nv">path: </span>  <span class="nx">fullpath</span>
      <span class="nv">headers:</span>
        <span class="s">&#39;Host&#39;</span><span class="o">:</span>          <span class="nx">@options</span><span class="p">.</span><span class="nx">hostname</span>
        <span class="s">&#39;Authorization&#39;</span><span class="o">:</span> <span class="s">&#39;Basic &#39;</span> <span class="o">+</span> <span class="k">new</span> <span class="nx">Buffer</span><span class="p">(</span><span class="s">&quot;</span><span class="si">#{</span><span class="nx">@options</span><span class="p">.</span><span class="nx">username</span><span class="si">}</span><span class="s">:</span><span class="si">#{</span><span class="nx">@options</span><span class="p">.</span><span class="nx">password</span><span class="si">}</span><span class="s">&quot;</span><span class="p">).</span><span class="nx">toString</span><span class="p">(</span><span class="s">&#39;base64&#39;</span><span class="p">)</span>
    <span class="nx">client</span><span class="p">.</span><span class="kc">on</span> <span class="s">&#39;error&#39;</span><span class="p">,</span> <span class="nf">(err) -&gt;</span> <span class="nx">fn</span> <span class="nx">err</span><span class="p">,</span> <span class="p">{}</span>
    <span class="nx">client</span><span class="p">.</span><span class="nx">end</span><span class="p">()</span>
    <span class="nx">client</span><span class="p">.</span><span class="kc">on</span> <span class="s">&#39;response&#39;</span><span class="p">,</span> <span class="nf">(response) -&gt;</span>
      <span class="k">if</span> <span class="nx">response</span><span class="p">.</span><span class="nx">statusCode</span> <span class="o">!=</span> <span class="mi">200</span>
        <span class="k">return</span> <span class="nx">fn</span> <span class="p">{</span><span class="s">&quot;code&quot;</span><span class="o">:</span> <span class="s">&quot;BADSTATUSCODE&quot;</span><span class="p">,</span> <span class="s">&quot;message&quot;</span><span class="o">:</span> <span class="nx">response</span><span class="p">.</span><span class="nx">statusCode</span><span class="p">},</span> <span class="p">{}</span>
      <span class="nv">buffer = </span><span class="s">&#39;&#39;</span>
      <span class="nx">response</span><span class="p">.</span><span class="kc">on</span> <span class="s">&#39;data&#39;</span><span class="p">,</span> <span class="nf">(chunk) -&gt;</span>
        <span class="nx">buffer</span> <span class="o">+=</span> <span class="nx">chunk</span>
      <span class="nx">response</span><span class="p">.</span><span class="kc">on</span> <span class="s">&#39;end&#39;</span><span class="p">,</span> <span class="o">-&gt;</span>
        <span class="nx">fn</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">buffer</span> <span class="k">if</span> <span class="nx">fn</span>

  <span class="nv">parseXml: </span><span class="p">(</span><span class="nx">buffer</span><span class="p">,</span> <span class="nv">fn = </span><span class="kc">null</span><span class="p">)</span> <span class="o">=&gt;</span>
    <span class="nv">x2js = </span><span class="k">new</span> <span class="p">(</span><span class="nx">require</span><span class="p">(</span><span class="s">&#39;xml2js&#39;</span><span class="p">)).</span><span class="nx">Parser</span> <span class="p">{}</span>
    <span class="nx">x2js</span><span class="p">.</span><span class="kc">on</span> <span class="s">&#39;end&#39;</span><span class="p">,</span> <span class="nf">(result) -&gt;</span> <span class="nx">fn</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">result</span>
    <span class="nx">x2js</span><span class="p">.</span><span class="nx">parseString</span> <span class="nx">buffer</span>

  <span class="nv">fetchAndParse: </span><span class="p">(</span><span class="nx">path</span><span class="p">,</span> <span class="nv">fn = </span><span class="kc">null</span><span class="p">)</span> <span class="o">=&gt;</span>
    <span class="nx">@fetchXml</span> <span class="nx">path</span><span class="p">,</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">buffer</span><span class="p">)</span> <span class="o">=&gt;</span>
      <span class="k">return</span> <span class="nx">fn</span> <span class="nx">err</span><span class="p">,</span> <span class="p">{}</span> <span class="k">if</span> <span class="nx">err</span>
      <span class="nx">@parseXml</span> <span class="nx">buffer</span><span class="p">,</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">object</span><span class="p">)</span> <span class="o">=&gt;</span>
        <span class="k">return</span> <span class="nx">fn</span> <span class="nx">err</span><span class="p">,</span> <span class="nx">object</span> <span class="k">if</span> <span class="nx">err</span>
        <span class="k">return</span> <span class="nx">fn</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">object</span></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <p>This admin function provides the ability to query the internal statistics kept by the icecast server. Almost all information about the internal workings of the server such as the mountpoints connected, how many client requests have been served, how many listeners for each mountpoint, etc, are available via this admin function.
Note that this admin function can also be invoked via the http://server:port/admin/stats.xml syntax, however this syntax should not be used and will eventually become deprecated.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">stats: </span><span class="p">(</span><span class="nv">fn = </span><span class="kc">null</span><span class="p">)</span> <span class="o">=&gt;</span>
    <span class="nx">@fetchAndParse</span> <span class="s">&quot;admin/stats&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">object</span><span class="p">)</span> <span class="o">=&gt;</span>
      <span class="k">return</span> <span class="nx">fn</span> <span class="p">{</span><span class="s">&quot;code&quot;</span><span class="o">:</span> <span class="s">&#39;INVALID XML&#39;</span><span class="p">},</span> <span class="nx">object</span> <span class="nx">unless</span> <span class="nx">object</span><span class="p">.</span><span class="nx">icestats</span><span class="o">?</span><span class="p">.</span><span class="nx">source</span><span class="o">?</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">?</span>
      <span class="k">return</span> <span class="nx">fn</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">object</span></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <p>This admin function provides the ability to view all the currently connected mountpoints.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">listMounts: </span><span class="p">(</span><span class="nv">fn = </span><span class="kc">null</span><span class="p">)</span> <span class="o">=&gt;</span>
    <span class="nx">@fetchAndParse</span> <span class="s">&quot;admin/listmounts&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">object</span><span class="p">)</span> <span class="o">=&gt;</span>
      <span class="k">return</span> <span class="nx">fn</span> <span class="p">{</span><span class="s">&quot;code&quot;</span><span class="o">:</span> <span class="s">&#39;INVALID XML&#39;</span><span class="p">},</span> <span class="nx">object</span> <span class="nx">unless</span> <span class="nx">object</span><span class="p">.</span><span class="nx">icestats</span><span class="o">?</span><span class="p">.</span><span class="nx">source</span><span class="o">?</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">?</span>
      <span class="k">return</span> <span class="nx">fn</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">object</span></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p>This function lists all the clients currently connected to a specific mountpoint. The results are sent back in XML form.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">listClients: </span><span class="p">(</span><span class="nx">mountpoint</span><span class="p">,</span> <span class="nv">fn = </span><span class="kc">null</span><span class="p">)</span> <span class="o">=&gt;</span>
    <span class="nx">@fetchAndParse</span> <span class="s">&quot;admin/listclients?mount=</span><span class="si">#{</span><span class="nx">mountpoint</span><span class="si">}</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">object</span><span class="p">)</span> <span class="o">=&gt;</span>
      <span class="k">return</span> <span class="nx">fn</span> <span class="p">{</span><span class="s">&quot;code&quot;</span><span class="o">:</span> <span class="s">&#39;INVALID XML&#39;</span><span class="p">},</span> <span class="nx">object</span> <span class="nx">unless</span> <span class="nx">object</span><span class="p">.</span><span class="nx">icestats</span><span class="o">?</span><span class="p">.</span><span class="nx">source</span><span class="o">?</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">?</span>
      <span class="k">return</span> <span class="nx">fn</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">object</span></pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <p>This function provides the ability for either a source client or any external program to update the metadata information for a particular mountpoint.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">updateMetadata: </span><span class="p">(</span><span class="nx">options</span><span class="p">,</span> <span class="nv">fn = </span><span class="kc">null</span><span class="p">)</span> <span class="o">=&gt;</span>
    <span class="k">return</span> <span class="nx">fn</span> <span class="p">{</span><span class="s">&quot;BADPARAMS&quot;</span><span class="p">},</span> <span class="p">{}</span> <span class="nx">unless</span> <span class="nx">options</span><span class="p">.</span><span class="nx">mount</span><span class="o">?</span>
    <span class="k">return</span> <span class="nx">fn</span> <span class="p">{</span><span class="s">&quot;BADPARAMS&quot;</span><span class="p">},</span> <span class="p">{}</span> <span class="nx">unless</span> <span class="nx">options</span><span class="p">.</span><span class="nx">song</span><span class="o">?</span>
    <span class="nx">@fetchAndParse</span> <span class="s">&quot;admin/metadata?mount=</span><span class="si">#{</span><span class="nx">options</span><span class="p">.</span><span class="nx">mount</span><span class="si">}</span><span class="s">&amp;mode=updinfo&amp;song=</span><span class="si">#{</span><span class="nb">encodeURI</span><span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">song</span><span class="p">)</span><span class="si">}</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">object</span><span class="p">)</span> <span class="o">=&gt;</span>
      <span class="k">return</span> <span class="nx">fn</span> <span class="p">{</span><span class="s">&quot;code&quot;</span><span class="o">:</span> <span class="s">&quot;INVALID XML&quot;</span><span class="p">},</span> <span class="nx">object</span> <span class="nx">unless</span> <span class="nx">object</span><span class="p">.</span><span class="nx">iceresponse</span><span class="o">?</span><span class="p">.</span><span class="nx">message</span><span class="o">?</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">?</span>
      <span class="k">return</span> <span class="nx">fn</span> <span class="nx">err</span><span class="p">,</span> <span class="nx">object</span></pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <p>This function provides the ability for either a source client or any external program to update the "fallback mountpoint" for a particular mountpoint. Fallback mounts are those that are used in the even of a source client disconnection. If a source client disconnects for some reason that all currently connected clients are sent immediately to the fallback mountpoint.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">updateFallback: </span><span class="p">(</span><span class="nx">options</span><span class="p">,</span> <span class="nv">fn = </span><span class="kc">null</span><span class="p">)</span> <span class="o">=&gt;</span>
    <span class="k">return</span> <span class="nx">fn</span> <span class="p">{</span><span class="s">&quot;BADPARAMS&quot;</span><span class="p">},</span> <span class="p">{}</span> <span class="nx">unless</span> <span class="nx">options</span><span class="p">.</span><span class="nx">mount</span><span class="o">?</span>
    <span class="k">return</span> <span class="nx">fn</span> <span class="p">{</span><span class="s">&quot;BADPARAMS&quot;</span><span class="p">},</span> <span class="p">{}</span> <span class="nx">unless</span> <span class="nx">options</span><span class="p">.</span><span class="nx">fallback</span><span class="o">?</span>
    <span class="nx">@fetchAndParse</span> <span class="s">&quot;admin/fallbacks?mount=</span><span class="si">#{</span><span class="nx">options</span><span class="p">.</span><span class="nx">mount</span><span class="si">}</span><span class="s">&amp;fallback=</span><span class="si">#{</span><span class="nx">options</span><span class="p">.</span><span class="nx">fallback</span><span class="si">}</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">object</span><span class="p">)</span> <span class="o">=&gt;</span>
      <span class="k">return</span> <span class="nx">fn</span> <span class="p">{</span><span class="s">&quot;code&quot;</span><span class="o">:</span> <span class="s">&quot;FAILED&quot;</span><span class="p">},</span> <span class="nx">object</span> <span class="nx">unless</span> <span class="nx">object</span><span class="p">.</span><span class="nx">html</span><span class="o">?</span><span class="p">.</span><span class="nx">head</span><span class="o">?</span>
      <span class="k">return</span> <span class="nx">fn</span> <span class="nx">err</span><span class="p">,</span> <span class="nx">object</span></pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <p>This function provides the ability to migrate currently connected listeners from one mountpoint to another. This function requires 2 mountpoints to be passed in: mount (the <em>from</em> mountpoint) and destination (the <em>to</em> mountpoint). After processing this function all currently connected listeners on mount will be connected to destination. Note that the destination mountpoint must exist and have a sounce client already feeding it a stream.
http://192.168.1.10:8000/admin/moveclients?mount=/mystream.ogg&amp;destination=/mynewstream.ogg</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">moveCLients: </span><span class="o">=&gt;</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="s">&quot;TODO&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <p>This function provides the ability to disconnect a specific listener of a currently connected mountpoint. Listeners are identified by a unique id that can be retrieved by via the "List Clients" admin function. This id must be passed in to the request. After processing this request, the listener will no longer be connected to the mountpoint.
http://192.168.1.10:8000/admin/killclient?mount=/mystream.ogg&amp;id=21</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">killClient: </span><span class="o">=&gt;</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="s">&quot;TODO&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <p>This function will provide the ability to disconnect a specific mountpoint from the server. The mountpoint to be disconnected is specified via the variable "mount".
http://192.168.1.10:8000/admin/killsource?mount=/mystream.ogg</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">killSource: </span><span class="o">=&gt;</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="s">&quot;TODO&quot;</span>


<span class="nv">module.exports = </span><span class="nx">Admin</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 